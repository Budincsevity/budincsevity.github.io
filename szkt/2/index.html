<!DOCTYPE html>
<html>
  <head>
    <title>2-es villamos</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
			html, body, #map-canvas {
				height: 100%;
				margin: 0px;
				padding: 0px
			}
			#panel {
        width: auto;
				position: absolute;
				top: 5px;
				left: 50%;
				z-index: 5;
				background-color: rgba(0, 0, 0, 0.5);
				padding: 5px;
				border: 1px solid #999;
        color: white;
        font-family: Arial;
        font-size: 22px;
        text-align: center;
			}
		</style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=geometry"></script>

    <script>
// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see a blank space instead of the map, this
// is probably because you have denied permission for location sharing.

var map;
var directionsService = new google.maps.DirectionsService();
var directionsDisplay;
var locationData = [
  new google.maps.LatLng(46.273596, 20.147050),
  new google.maps.LatLng(46.272220, 20.143077),
  new google.maps.LatLng(46.270782, 20.139110),
  new google.maps.LatLng(46.269165, 20.135835),
  new google.maps.LatLng(46.266623, 20.132448),
  new google.maps.LatLng(46.263747, 20.132367),
  new google.maps.LatLng(46.262823, 20.134972),
  new google.maps.LatLng(46.260766, 20.138901),
  new google.maps.LatLng(46.259159, 20.141914),
  new google.maps.LatLng(46.256043, 20.147736),
  new google.maps.LatLng(46.252630, 20.149168),
  new google.maps.LatLng(46.250244, 20.147646),
  new google.maps.LatLng(46.247698, 20.146865),
  new google.maps.LatLng(46.243276, 20.143570),
  new google.maps.LatLng(46.240156, 20.141166),
  new google.maps.LatLng(46.240044, 20.142872)
];

var names = [
  "Európa liget",
  "Vértó",
  "Rókusi II. sz. Ált.",
  "Rókusi víztorony",
  "Szatymazi utca",
  "Vásárhelyi Pál utca",
  "Damjanich u.",
  "Tavasz utca",
  "Rókusi templom",
  "Anna - kút",
  "Széchenyi tér",
  "Somogyi utca",
  "Aradi vértanúk tere",
  "Bécsi krt.",
  "Bem utca",
  "Szeged pu."
];


// 0: From Európa liget
// 1: From Szeged pu.
var travelTime = [
  [0, 18],
  [1, 17],
  [2, 16],
  [4, 14],
  [5, 13],
  [7, 12],
  [8, 10],
  [9, 9],
  [10, 8],
  [12, 7],
  [13, 5],
  [14, 4],
  [15, 3],
  [17, 2],
  [18, 1],
  [19, 0]
];

var departureTimeFromEuropaL = [
  new Date(2000, 0, 1, 4, 00, 0, 0),
  new Date(2000, 0, 1, 4, 20, 0, 0),
  new Date(2000, 0, 1, 4, 40, 0, 0),

  new Date(2000, 0, 1, 5, 00, 0, 0),
  new Date(2000, 0, 1, 5, 20, 0, 0),
  new Date(2000, 0, 1, 5, 35, 0, 0),
  new Date(2000, 0, 1, 5, 50, 0, 0),

  new Date(2000, 0, 1, 6, 00, 0, 0),
  new Date(2000, 0, 1, 6, 10, 0, 0),
  new Date(2000, 0, 1, 6, 20, 0, 0),
  new Date(2000, 0, 1, 6, 30, 0, 0),
  new Date(2000, 0, 1, 6, 37, 0, 0),
  new Date(2000, 0, 1, 6, 45, 0, 0),
  new Date(2000, 0, 1, 6, 52, 0, 0),

  new Date(2000, 0, 1, 7, 00, 0, 0),
  new Date(2000, 0, 1, 7, 06, 0, 0),
  new Date(2000, 0, 1, 7, 12, 0, 0),
  new Date(2000, 0, 1, 7, 18, 0, 0),
  new Date(2000, 0, 1, 7, 24, 0, 0),
  new Date(2000, 0, 1, 7, 30, 0, 0),
  new Date(2000, 0, 1, 7, 36, 0, 0),
  new Date(2000, 0, 1, 7, 42, 0, 0),
  new Date(2000, 0, 1, 7, 48, 0, 0),
  new Date(2000, 0, 1, 7, 54, 0, 0),

  new Date(2000, 0, 1, 8, 00, 0, 0),
  new Date(2000, 0, 1, 8, 07, 0, 0),
  new Date(2000, 0, 1, 8, 15, 0, 0),
  new Date(2000, 0, 1, 8, 22, 0, 0),
  new Date(2000, 0, 1, 8, 30, 0, 0),
  new Date(2000, 0, 1, 8, 37, 0, 0),
  new Date(2000, 0, 1, 8, 45, 0, 0),
  new Date(2000, 0, 1, 8, 52, 0, 0),

  new Date(2000, 0, 1, 9, 00, 0, 0),
  new Date(2000, 0, 1, 9, 07, 0, 0),
  new Date(2000, 0, 1, 9, 15, 0, 0),
  new Date(2000, 0, 1, 9, 22, 0, 0),
  new Date(2000, 0, 1, 9, 30, 0, 0),
  new Date(2000, 0, 1, 9, 37, 0, 0),
  new Date(2000, 0, 1, 9, 45, 0, 0),
  new Date(2000, 0, 1, 9, 52, 0, 0),

  new Date(2000, 0, 1, 10, 00, 0, 0),
  new Date(2000, 0, 1, 10, 10, 0, 0),
  new Date(2000, 0, 1, 10, 20, 0, 0),
  new Date(2000, 0, 1, 10, 30, 0, 0),
  new Date(2000, 0, 1, 10, 40, 0, 0),
  new Date(2000, 0, 1, 10, 50, 0, 0),

  new Date(2000, 0, 1, 11, 00, 0, 0),
  new Date(2000, 0, 1, 11, 10, 0, 0),
  new Date(2000, 0, 1, 11, 20, 0, 0),
  new Date(2000, 0, 1, 11, 30, 0, 0),
  new Date(2000, 0, 1, 11, 40, 0, 0),
  new Date(2000, 0, 1, 11, 50, 0, 0),

  new Date(2000, 0, 1, 12, 00, 0, 0),
  new Date(2000, 0, 1, 12, 10, 0, 0),
  new Date(2000, 0, 1, 12, 20, 0, 0),
  new Date(2000, 0, 1, 12, 30, 0, 0),
  new Date(2000, 0, 1, 12, 40, 0, 0),
  new Date(2000, 0, 1, 12, 50, 0, 0),

  new Date(2000, 0, 1, 13, 00, 0, 0),
  new Date(2000, 0, 1, 13, 07, 0, 0),
  new Date(2000, 0, 1, 13, 15, 0, 0),
  new Date(2000, 0, 1, 13, 22, 0, 0),
  new Date(2000, 0, 1, 13, 30, 0, 0),
  new Date(2000, 0, 1, 13, 37, 0, 0),
  new Date(2000, 0, 1, 13, 45, 0, 0),
  new Date(2000, 0, 1, 13, 52, 0, 0),

  new Date(2000, 0, 1, 14, 00, 0, 0),
  new Date(2000, 0, 1, 14, 07, 0, 0),
  new Date(2000, 0, 1, 14, 15, 0, 0),
  new Date(2000, 0, 1, 14, 22, 0, 0),
  new Date(2000, 0, 1, 14, 30, 0, 0),
  new Date(2000, 0, 1, 14, 37, 0, 0),
  new Date(2000, 0, 1, 14, 45, 0, 0),
  new Date(2000, 0, 1, 14, 52, 0, 0),

  new Date(2000, 0, 1, 15, 00, 0, 0),
  new Date(2000, 0, 1, 15, 07, 0, 0),
  new Date(2000, 0, 1, 15, 15, 0, 0),
  new Date(2000, 0, 1, 15, 22, 0, 0),
  new Date(2000, 0, 1, 15, 30, 0, 0),
  new Date(2000, 0, 1, 15, 37, 0, 0),
  new Date(2000, 0, 1, 15, 45, 0, 0),
  new Date(2000, 0, 1, 15, 52, 0, 0),

  new Date(2000, 0, 1, 16, 00, 0, 0),
  new Date(2000, 0, 1, 16, 07, 0, 0),
  new Date(2000, 0, 1, 16, 15, 0, 0),
  new Date(2000, 0, 1, 16, 22, 0, 0),
  new Date(2000, 0, 1, 16, 30, 0, 0),
  new Date(2000, 0, 1, 16, 37, 0, 0),
  new Date(2000, 0, 1, 16, 45, 0, 0),
  new Date(2000, 0, 1, 16, 52, 0, 0),

  new Date(2000, 0, 1, 17, 00, 0, 0),
  new Date(2000, 0, 1, 17, 07, 0, 0),
  new Date(2000, 0, 1, 17, 15, 0, 0),
  new Date(2000, 0, 1, 17, 22, 0, 0),
  new Date(2000, 0, 1, 17, 30, 0, 0),
  new Date(2000, 0, 1, 17, 37, 0, 0),
  new Date(2000, 0, 1, 17, 45, 0, 0),
  new Date(2000, 0, 1, 17, 52, 0, 0),

  new Date(2000, 0, 1, 18, 00, 0, 0),
  new Date(2000, 0, 1, 18, 10, 0, 0),
  new Date(2000, 0, 1, 18, 20, 0, 0),
  new Date(2000, 0, 1, 18, 30, 0, 0),
  new Date(2000, 0, 1, 18, 40, 0, 0),
  new Date(2000, 0, 1, 18, 50, 0, 0),

  new Date(2000, 0, 1, 19, 00, 0, 0),
  new Date(2000, 0, 1, 19, 10, 0, 0),
  new Date(2000, 0, 1, 19, 20, 0, 0),
  new Date(2000, 0, 1, 19, 30, 0, 0),
  new Date(2000, 0, 1, 19, 45, 0, 0),

  new Date(2000, 0, 1, 20, 00, 0, 0),
  new Date(2000, 0, 1, 20, 15, 0, 0),
  new Date(2000, 0, 1, 20, 30, 0, 0),
  new Date(2000, 0, 1, 20, 35, 0, 0),

  new Date(2000, 0, 1, 21, 00, 0, 0),
  new Date(2000, 0, 1, 21, 15, 0, 0),
  new Date(2000, 0, 1, 21, 30, 0, 0),
  new Date(2000, 0, 1, 21, 45, 0, 0),

  new Date(2000, 0, 1, 22, 00, 0, 0),
  new Date(2000, 0, 1, 22, 20, 0, 0),
  new Date(2000, 0, 1, 22, 40, 0, 0),

  new Date(2000, 0, 1, 23, 00, 0, 0),
  new Date(2000, 0, 1, 23, 20, 0, 0),
  new Date(2000, 0, 1, 23, 40, 0, 0),
];

console.log(new Date());

var departureTimeFromSzegedP = [

];

function initialize() {
  var mapOptions = {
    zoom: 25
  };
  directionsDisplay = new google.maps.DirectionsRenderer();
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
      directionsDisplay.setMap(map);
  // Try HTML5 geolocation
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);

      var distances = [];



      map.setCenter(pos);

      locationData.forEach(logArrayElements);
      function logArrayElements(element, index, array) {

        distances.push(google.maps.geometry.spherical.computeDistanceBetween (pos, element));
      }

      var min = Math.min.apply(Math, distances);
      var minIndex = distances.indexOf(min);

      console.log(distances.indexOf(min));
      console.log(names[minIndex]);

      $("#text").text('Legközelebbi megálló: ' + names[minIndex]);

      var now = new Date();
      now.setDate(1);
      now.setMonth(0);
      now.setYear(2000);

      var date = new Date(departureTimeFromEuropaL[0].getTime() + travelTime[minIndex, 0] * 60000);
      var diffMin = Math.abs(now - date);
      var minIndexForStation = 0;

      departureTimeFromEuropaL.forEach(findMinDiff);
      function findMinDiff(element, index, array) {
        if (index > 0) {
          console.log("all: " + departureTimeFromEuropaL[index]);
          if(departureTimeFromEuropaL[index] > now) {
            var date = new Date(departureTimeFromEuropaL[index].getTime() + travelTime[minIndex][0] * 60000);
            var diff = Math.abs(now - date);
            console.log("now: " + now);
            console.log("diff: " + diff);
            console.log("diffMin: " + diffMin);
            if (diff < diffMin) {
              console.log("min: " + departureTimeFromEuropaL[minIndex]);
              console.log("now: " + now);
              diffMin = diff;
              minIndexForStation = index;
            }
          }
        }
      }

      console.log(Math.floor(diffMin / 60000));
      $("#date").text(Math.floor(diffMin / 60000) + ' perc múlva');

      var request = {
            origin: pos,
            destination: locationData[minIndex],
            // Note that Javascript allows us to access the constant
            // using square brackets and a string value as its
            // "property."
            travelMode: google.maps.TravelMode.WALKING
        };
        directionsService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);

            var infowindow = new google.maps.InfoWindow({
              map: map,
              position: pos,
              content: 'Idő: ' + Math.round((response.routes[0].legs[0].duration.value) / 60) + ' perc'
            });
          }
        });

    }, function() {
      handleNoGeolocation(true);
    });
  } else {
    // Browser doesn't support Geolocation
    handleNoGeolocation(false);
  }
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Error: The Geolocation service failed.';
  } else {
    var content = 'Error: Your browser doesn\'t support geolocation.';
  }

  var options = {
    map: map,
    position: new google.maps.LatLng(60, 105),
    content: content
  };

  var infowindow = new google.maps.InfoWindow(options);

  map.setCenter(options.position);
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="panel">
      <p id="text"></p>
      <p id="date">0 perc múlva</p>
      <p id="date">0 perc múlva</p>
    </div>
    <div id="map-canvas"></div>
  </body>
  </body>
</html>
